extends layout
block content
	//- set up some string vars to be used in this template
	heading       = 'Upcoming Events';
	url           = '/search/events/';
	seeMore       = 'See more events';
	lastEventDate = '';
	lastEventId   = undefined;
	- if ((typeof events != "undefined") && (typeof events[0] !== "undefined"))
		- lastEventDate = new Date(events[events.length-1].Date).format('mm-dd-yy');
		- lastEventId = events[events.length-1].ID;

	- if (req.session.visitor.tracking.city)
		- heading += ' Near '+req.session.visitor.tracking.city;
		- url     += req.session.visitor.tracking.city+'/';
		- seeMore += ' near '+req.session.visitor.tracking.city;

	- if (search)
		- heading = 'Events matching "'+search+'"'
		- seeMore = 'See more events matching "'+search+'"'
		- var placeholder = search
		- url = '/search/events/' + search + '/';
	- else
		- var search = "";
		- var placeholder = 'Enter an event, team or venue...'
	- url += Date.today().format("mm-dd-yy")
	#search(ng-controller="SearchCtrl")
		input(type="hidden", name="search", value="#{search}", ng-init="search='#{search}'")
		input(type="hidden", name="city", value="#{req.session.visitor.tracking.city}", ng-init="city='#{req.session.visitor.tracking.city}'")
		input(type="hidden", name="postalCode", value="#{req.session.visitor.tracking.postalCode}", ng-init="postalCode='#{req.session.visitor.tracking.postalCode}'")
		input(type="hidden", name="lastEventDate", ng-init="lastEventDate='#{lastEventDate}'", value="#{lastEventDate}")
		input(type="hidden", name="lastEventId", ng-init="lastEventId='#{lastEventId}'", value="#{lastEventId}")

		#payment-type-modal.modal.fade
			.modal-dialog
				#payment-type.modal-content
					.modal-header
						button(type="button", class="close", data-dismiss="modal")&times;
						h2.modal-title {{event.Name}}
						h3.modal-subtitle Share the cost with your friends or pay for it all on your own?
					form#payment-type-form(novalidate name="payment-type-form")
						.modal-body
							.form-group
								label.radio.clearfix
									input#option-split-first.form-control.hide(ng-model="paymentType",type="radio",name="payment_type",value="split-first",ng-init="paymentType='split-first'")
									i.fa.fa-check-circle-o.fa-2x.pull-left.green(ng-show="{'split-first':true}[paymentType]")
									i.fa.fa-circle-o.fa-2x.pull-left(ng-show="!{'split-first':true}[paymentType]")
									.option-content.pull-left
										h3 Everyone Pays Up Front
										p Tired of getting stuck with the bill? Breathe easy, just pick an event, invite friends, and have them pony up before shelling out any cash.
								label.radio.clearfix
									input#option-split-after.form-control.hide(ng-model="paymentType",type="radio",name="payment_type",value="split-after")
									i.fa.fa-check-circle-o.fa-2x.pull-left.green(ng-show="{'split-after':true}[paymentType]")
									i.fa.fa-circle-o.fa-2x.pull-left(ng-show="!{'split-after':true}[paymentType]")
									.option-content.pull-left
										h3 I'll Pay First, Then Collect Later
										p Want to guarantee you all get seats together?  Buy the tickets now then use Wembli to split the bill later. Better safe than sitting solo!
								label.radio.clearfix
									input#option-no-split.hide(ng-model="paymentType", type="radio",name="payment_type",value="no-split")
									i.fa.fa-check-circle-o.fa-2x.pull-left.green(ng-show="{'no-split':true}[paymentType]")
									i.fa.fa-circle-o.fa-2x.pull-left(ng-show="!{'no-split':true}[paymentType]")
									.option-content.pull-left
										h3 I Want To Buy Tickets Now
										p Search for your event, buy your tickets and you're on your way!
						.modal-footer
							button.btn.btn-primary.btn-large(ng-hide="submitInProgress", ng-click="startPlan()")
								span(ng-show="{'split-first':true}[paymentType]") Invite Friends!&nbsp;
								span(ng-show="{'split-after':true}[paymentType]") See Tickets!&nbsp;
								span(ng-show="{'no-split':true}[paymentType]") See Tickets!&nbsp;
							button.btn.btn-primary.btn-large.mute(ng-disabled="submitInProgress", ng-show="submitInProgress",ng-click="startPlan()")
								.icon.icon-cog.icon-spin.pull-left
								span(ng-show="{'split-first':true}[paymentType]") Invite Friends!&nbsp;
								span(ng-show="{'split-after':true}[paymentType]") See Tickets!&nbsp;
								span(ng-show="{'no-split':true}[paymentType]") See Tickets!&nbsp;

		.container
			.row
				#search-left.col-md-4.hidden-xs.hidden-sm
					img(src="/images/search-arrow.png").img-responsive.search-arrow
					.copy.segoe Search for the event you want to go to...
					img(src="/images/question.png").img-responsive.wembliman

				#search-right.col-md-8.col-xs-12
					.search-box
						form#search-form.search-form.clearfix(method="GET", action="/search/events", ng-submit="submitSearch()")
							i.fa.fa-search.pull-left(ng-hide="searchInProgress")
							i.fa.fa-cog.fa-spin.pull-left(ng-show="searchInProgress")
							input#query.pull-left(type="text", ng-model="search", name="search", placeholder="enter an event, team or venue, city or zip code")
							button.btn.btn-secondary.segoe.pull-left(href="#") search

					.results(ng-controller="EventListCtrl")
						//- event list
						#event-list-wrapper
							h3= heading
							ul.event-list-waypoint
								if ((typeof events !== "undefined") && (typeof events[0] !== "undefined"))
									each event in events
										li.row.show-ticket-range(event-id="#{event.ID}",name="#{event.Name}",id="#{event.ID}-wrapper")
											- var lastSearch = visitor.lastSearch ? visitor.lastSearch : '/search';
											- lastSearch += '?updateEvent=1';
											- var date = new Date(Date.parse(event.Date));
											- var location = event.City+', '+event.StateProvince;
											- var payment;
											- if (typeof btnText === "undefined")
												- var btnText = 'Plan It';
											- if ((typeof plan !== "undefined") && (typeof plan.preferences !== "undefined"))
												- payment = plan.preferences.payment;
											.col-sm-2
												.event-date-box
													span.day!=        date.format("ddd")
													span.event-date!= date.format("mmm d")
													span.time!=       date.format("h:MM TT")
											.col-sm-7
												.info
													span.name.block= event.Name
													span.venue.block= (typeof event.Venue.Name != "undefined") ? event.Venue.Name : event.Venue
													span.location.block= location
													- if (typeof changeEvent != "undefined" && changeEvent == true)
														span.changeEvent.block
															a#changeEvent(href="http://#{app.settings.host}.wembli.com/search/#{lastSearch}") Change Event
											.col-sm-3.col-xs-12
												.cta.col-xs-4.col-sm-12
													a.btn.btn-primary.prevent-default(ng-click="openPaymentModal({ID: \"#{event.ID}\",Name: \"#{event.Name}\"})",id="#{event.ID}", name="#{event.Name}", href="/tickets/"+event.ID+"/"+event.Name) Start Plan
												.ticket-range.col-xs-8.col-sm-12
													i.fa.fa-cog.fa-spin(ng-show="ticketSummaryData['#{event.ID}'].locked")
													span.visible-xs.visible-sm
														span(ng-hide="ticketSummaryData['#{event.ID}'] || ticketSummaryData['#{event.ID}'].locked") Tap for ticket price range.
									//- this is needed for the more events client side functionality
									li.row.show-ticket-range(event-id="{{event.ID}}",name="{{event.Name}}",id="{{event.ID}}-wrapper",ng-repeat="event in events")
										- var lastSearch = req.session.lastSearch ? req.session.lastSearch : '/search';
										- lastSearch += '?updateEvent=1';
										- var payment;
										- if ((typeof plan !== "undefined") && (typeof plan.preferences !== "undefined"))
											- payment = plan.preferences.payment;
										.col-sm-2
											.event-date-box
												span.day {{getDate(event.Date)| date:'EEE'}}
												span.event-date {{getDate(event.Date)| date:'MMM d'}}
												span.time {{getDate(event.Date)| date:'h:mm a'}}
										.col-sm-7
											.info
												span.name.block {{event.Name}}
												span.venue.block {{ event.Venue.Name || event.Venue }}
												span.location.block {{event.City+', '+event.StateProvince}}
												- if (typeof changeEvent != "undefined" && changeEvent == true)
													span.changeEvent.block
														a#changeEvent(href="http://#{app.settings.host}.wembli.com/search/#{lastSearch}") Change Event
										.col-sm-3.col-xs-12
											.cta.col-xs-4.col-sm-12
												a.btn.btn-primary.prevent-default(ng-click="openPaymentModal(event)", id="{{event.ID}}",name="{{event.Name}}",ng-href="/tickets/{{event.ID}}/{{event.Name}}") Start Plan
											.ticket-range.col-xs-8.col-sm-12
												i.fa.fa-cog.fa-spin(ng-show="ticketSummaryData[event.ID].locked")
												span.visible-xs.visible-sm
													span(ng-hide="ticketSummaryData[event.ID] || ticketSummaryData[event.ID].locked") Tap for ticket price range.

									li.row.loading-more-events(ng-show="loadingMoreEvents")
										.icon.col-sm-2
											i.fa.fa-cog.fa-spin.fa-2x.pull-left
										.message.col-sm-10
											span loading more events...

									li.hide(ng-init="noMoreEvents=false")
								else
									li.hide(ng-init="noMoreEvents=true")

								li.no-results(ng-show="noMoreEvents")
									.notify-email(type="search")
										.collect-email(ng-hide="emailCollected")
											p Aww shucks! We haven't got any more event listings to show you.  Enter your email below if you'd like to be notified when events become available.
											fieldset
												input#email
										.collected-email(ng-show="emailCollected")
											p OK! We'll let you know if any events become available!
										.clearfix
											.back-to-search.pull-left
												a(href="/search") << Perform a new search
											button.btn.btn-primary.pull-right(ng-hide="emailCollected",ng-click="collectEmail()") Notify Me!




