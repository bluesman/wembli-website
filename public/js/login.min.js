/*! wembli-website 2014-02-28 */
"use strict";

angular.module("wembliApp", [ "ngRoute", "mgcrea.ngStrap", "wembliApp.controllers", "wembliApp.controllers.login", "wembliApp.controllers.header", "wembliApp.filters", "wembliApp.services", "wembliApp.services.header", "wembliApp.services.facebook", "wembliApp.services.twitter", "wembliApp.services.pixel", "wembliApp.directives", "wembliApp.directives.header" ]).config([ "$routeProvider", "$locationProvider", function() {} ]).run([ "$timeout", "initRootScope", "$rootScope", "$location", "$route", "$window", "facebook", "twitter", "plan", "wembliRpc", function($timeout, initRootScope, $scope, $location, $route, $window, facebook, twitter, plan) {
    console.log("run login angular app"), $timeout(function() {
        plan.fetch(function() {});
    }), $window.fbAsyncInit = function() {
        facebook.getLoginStatus(), $scope.facebook = facebook;
    }, twitter.getLoginStatus();
} ]), angular.module("wembliApp.controllers.login", []).controller("SupplyPasswordCtrl", [ "$scope", "wembliRpc", "$window", function($scope, wembliRpc, $window) {
    $scope.confirmPasswordForm = {}, $scope.confirmPasswordForm.passwordMismatch = !1, 
    $scope.confirmPasswordForm.fatalError = !1, $scope.confirmPasswordInProgress = !1, 
    $scope.email = $("#email").val(), $scope.token = $("#token").val(), $scope.redirectUrl = $("#redirectUrl").val(), 
    $scope.submitConfirmPasswordForm = function() {
        $scope.confirmPasswordForm.$invalid || ($scope.confirmPasswordInProgress = !0, console.log($scope.email), 
        wembliRpc.fetch("customer.resetPassword", {
            email: $scope.email,
            token: $scope.token,
            password: $scope.password,
            password2: $scope.password2
        }, function(err, results) {
            return console.log(err), console.log(results), err ? (console.log("fatal err"), 
            $scope.confirmPasswordForm.fatalError = err, $scope.confirmPasswordInProgress = !1, 
            void 0) : (results.passwordMismatch ? ($scope.confirmPasswordForm.passwordMismatch = results.passwordMismatch, 
            $scope.confirmPasswordInProgress = !1) : ($scope.confirmPasswordInProgress = !1, 
            $window.location.href = $scope.redirectUrl ? $scope.redirectUrl : "/dashboard"), 
            void 0);
        }));
    };
} ]).controller("SignupCtrl", [ "$scope", "$window", "wembliRpc", "pixel", "googleAnalytics", function($scope, $window, wembliRpc, pixel, googleAnalytics) {
    $scope.signupForm = {}, $scope.signupForm.exists = !1, $scope.signupForm.fatalError = !1, 
    $scope.signupInProgress = !1, $scope.submitSignupForm = function() {
        $scope.signupForm.$invalid || ($scope.signupInProgress = !0, wembliRpc.fetch("customer.signup", {
            firstName: $scope.firstName,
            lastName: $scope.lastName,
            email: $scope.email
        }, function(err, results) {
            if (err) return console.log("fatal err"), $scope.signupForm.fatalError = err, $scope.signupInProgress = !1, 
            void 0;
            if (results.exists) $scope.signupForm.exists = results.exists, $scope.signupInProgress = !1; else {
                var gCookie = googleAnalytics.getCookie();
                pixel.fire({
                    type: "signup",
                    campaign: gCookie.__utmz.utmccn,
                    source: "google",
                    medium: gCookie.__utmz.utmcmd,
                    term: gCookie.__utmz.utmctr,
                    content: "1070734106"
                }), pixel.fire({
                    type: "signup",
                    campaign: "Signup Conversion Pixel Facebook Ad",
                    source: "facebook",
                    medium: "cpc",
                    term: "",
                    content: "6013588786171"
                }), $scope.signupInProgress = !1, $window.location.href = $scope.redirectUrl ? $scope.redirectUrl : "/dashboard";
            }
        }));
    };
} ]).controller("LoginCtrl", [ "$scope", "$window", "wembliRpc", function($scope, $window, wembliRpc) {
    $scope.loginForm = {}, $scope.loginForm.invalidCredentials = !1, $scope.forgotPasswordForm = {}, 
    $scope.forgotPasswordForm.noCustomer = !1, $scope.forgotPasswordForm.success = !1, 
    $scope.forgotPasswordInProgress = !1, $scope.loginInProgress = !1, $scope.rememberEmail && ($scope.loginForm.email = $scope.rememberEmail, 
    $scope.loginForm.remember = !0), $scope.submitLoginForm = function() {
        return $scope.loginForm.$invalid ? (console.log("login form is not valid"), void 0) : ($scope.loginInProgress = !0, 
        $scope.loginForm.remember, wembliRpc.fetch("customer.login", {
            email: $scope.email,
            password: $scope.password
        }, function(err, results) {
            return $scope.loginInProgress = !1, err ? (console.log("fatal err"), $scope.loginForm.fatalError = err, 
            void 0) : (results.error ? $scope.loginForm.invalidCredentials = !0 : $window.location.href = $scope.redirectUrl ? $scope.redirectUrl : "/dashboard", 
            void 0);
        }), void 0);
    }, $scope.submitForgotPasswordForm = function() {
        $scope.forgotPasswordForm.$invalid || ($scope.forgotPasswordInProgress = !0, wembliRpc.fetch("customer.sendForgotPasswordEmail", {
            email: $scope.email
        }, function(err, results) {
            return $scope.forgotPasswordInProgress = !1, err ? ($scope.forgotPasswordForm.fatalError = err, 
            void 0) : (results.error ? $scope.forgotPasswordForm.noCustomer = !0 : $scope.forgotPasswordForm.success = !0, 
            void 0);
        }));
    };
} ]);