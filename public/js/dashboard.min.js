/*! wembli-website 2014-08-07 */
"use strict";

angular.module("wembliApp", [ "ngRoute", "ngAnimate", "mgcrea.ngStrap", "wembliApp.controllers", "wembliApp.controllers.dashboard", "wembliApp.controllers.header", "wembliApp.filters", "wembliApp.services", "wembliApp.services.header", "wembliApp.services.facebook", "wembliApp.services.twitter", "wembliApp.services.pixel", "wembliApp.directives", "wembliApp.directives.header", "wembliApp.directives.dashboard" ]).config([ "$routeProvider", "$locationProvider", function() {} ]).run([ "$timeout", "initRootScope", "$rootScope", "$location", "$route", "$window", "facebook", "twitter", "plan", "wembliRpc", function($timeout, initRootScope, $scope, $location, $route, $window, facebook, twitter, plan) {
    console.log("run dashboard angular app"), $timeout(function() {
        plan.fetch(function() {});
    }), $window.fbAsyncInit = function() {
        facebook.getLoginStatus(), $scope.facebook = facebook;
    }, twitter.getLoginStatus();
} ]), angular.module("wembliApp.controllers.dashboard", []).controller("DashboardMainCtrl", [ "$rootScope", "$scope", "$location", "plan", function($rootScope, $scope, $location, plan) {
    $scope.showList = $location.url(), console.log($scope.showList), $scope.deletePlan = function(guid) {
        console.log("delete plan: " + guid), plan.deactivate({
            guid: guid
        }, function(err, result) {
            console.log(result), $scope.dashboard.organizer.map(function(plan) {
                console.log("plan in map: "), console.log(plan);
            });
            for (var newAry = [], i = 0; i < $scope.dashboard.organizer.length; i++) $scope.dashboard.organizer[i].guid !== guid && newAry.push($scope.dashboard.organizer[i]);
            $scope.dashboard.organizer = newAry, console.log($scope.dashboard.organizer);
        });
    };
} ]).controller("DashboardSettingsCtrl", [ "$rootScope", "$scope", "$location", "wembliRpc", "plan", function($rootScope, $scope, $location, wembliRpc) {
    $scope.showDetail = $location.url(), $scope.submitInProgress = !1, $scope.changePassword = function() {
        if ($scope.changePasswordForm.$valid) {
            $scope.submitInProgress = !0;
            var args = {
                password: $scope.changePassword.password,
                password2: $scope.changePassword.password2
            };
            wembliRpc.fetch("customer.changePassword", args, function(err, result) {
                console.log(result), $scope.submitInProgress = !1, $scope.changePasswordForm.error = result.formError, 
                $scope.changePasswordForm.mismatch = result.passwordMismatch, $scope.changePasswordForm.tooShort = result.passwordTooShort, 
                $scope.changePasswordForm.error || ($scope.changePasswordForm.success = !0);
            });
        }
    };
} ]).controller("DashboardPaymentsCtrl", [ "$rootScope", "$scope", "$window", "$location", "plan", "customer", "wembliRpc", function($rootScope, $scope, $window, $location, plan, customer, wembliRpc) {
    $scope.showDetail = $location.url(), $scope.submitInProgress = !1, console.log($scope.showDetail), 
    $scope.$on("bank-account-created", function() {
        $window.location.href = "/dashboard/payment-information";
    }), $scope.addCreditCard = function() {
        if (!$scope.submitInProgress) {
            $scope.submitInProgress = !0, $scope.error = $scope.formError = $scope.success = !1;
            var args = {};
            args.cardHolderName = $scope.creditCard.cardHolderName, args.creditCardNumber = $scope.creditCard.creditCardNumber, 
            args.expirationDateMonth = $scope.creditCard.expirationDateMonth, args.expirationDateYear = $scope.creditCard.expirationDateYear, 
            args.cvv = $scope.creditCard.cvv, args.postalCode = $scope.creditCard.postalCode, 
            wembliRpc.fetch("customer.createCreditCard", args, function(err, result) {
                return console.log(result), $scope.submitInProgress = !1, err ? ($scope.error = !0, 
                $scope.errorMessage = err, void ($scope.success = !1)) : result.success ? ($scope.success = !0, 
                $rootScope.$broadcast("credit-card-created", result.friend), void ($window.location.href = "/dashboard/payment-information")) : ($scope.error = !0, 
                $scope.success = !1, void ($scope.errorMessage = result.error));
            });
        }
    }, $scope.deleteAccount = function() {
        $scope.submitInProgress = !0, wembliRpc.fetch("customer.deleteBankAccount", {}, function(err, result) {
            console.log(result), err && alert("something bad happened contact help@wembli.com"), 
            $window.location.href = "/dashboard/payment-information";
        });
    }, $scope.deleteCard = function() {
        $scope.submitInProgress = !0, wembliRpc.fetch("customer.deleteCreditCard", {}, function(err, result) {
            console.log(result), err && alert("something bad happened contact help@wembli.com"), 
            $window.location.href = "/dashboard/payment-information";
        });
    };
} ]), angular.module("wembliApp.directives.dashboard", []).directive("dashboard", [ "customer", "$rootScope", "wembliRpc", "$location", function(customer, $rootScope, wembliRpc) {
    return {
        restrict: "C",
        compile: function() {
            return function(scope) {
                scope.$on("customer-changed", function() {
                    scope.customer = customer.get(), scope.noValidBankAccounts = !0, "undefined" != typeof scope.customer.balancedAPI && "undefined" != typeof scope.customer.balancedAPI.bankAccounts && angular.forEach(scope.customer.balancedAPI.bankAccounts.items, function(bank) {
                        bank.is_valid && (scope.needBankAccountInfo = !1);
                    }), "undefined" != typeof scope.customer.balancedAPI && "undefined" != typeof scope.customer.balancedAPI.creditCards && angular.forEach(scope.customer.balancedAPI.creditCards.items, function(bank) {
                        bank.is_valid && (scope.needCreditCardInfo = !1);
                    });
                }), wembliRpc.fetch("dashboard.init", {}, function(err, result) {
                    return err ? void alert("error happened - contact help@wembli.com") : (("undefined" == typeof result.customer.balancedAPI || "undefined" == typeof result.customer.balancedAPI.creditCards || "undefined" == typeof result.customer.balancedAPI.creditCards.items[0]) && (scope.needCreditCardInfo = !0), 
                    ("undefined" == typeof result.customer.balancedAPI || "undefined" == typeof result.customer.balancedAPI.bankAccounts || "undefined" == typeof result.customer.balancedAPI.bankAccounts.items[0]) && (scope.needBankAccountInfo = !0), 
                    scope.dashboard = result, customer.set(result.customer), console.log(result), void $rootScope.$broadcast("dashboard-fetched", result));
                });
            };
        }
    };
} ]).directive("updateCustomerInfoButton", [ "$rootScope", function($rootScope) {
    return {
        restrict: "C",
        replace: !1,
        cache: !1,
        compile: function() {
            return function(scope, element) {
                element.click(function() {
                    $rootScope.$broadcast("dashboard-updateCustomerInfo", {});
                });
            };
        }
    };
} ]).directive("updateCustomerInfo", [ "customer", "wembliRpc", "$rootScope", "$location", function(customer, wembliRpc, $rootScope, $location) {
    return {
        restrict: "C",
        replace: !1,
        cache: !1,
        compile: function() {
            return function(scope) {
                scope.$on("dashboard-updateCustomerInfo", function() {
                    scope.customer = customer.get();
                }), scope.updateCustomerInfo = function() {
                    var accountInfo = {
                        name: scope.customer.balancedAPI.customerAccount.name,
                        email: scope.customer.balancedAPI.customerAccount.email,
                        meta: scope.customer.balancedAPI.customerAccount.meta,
                        ssn_last4: scope.customer.balancedAPI.customerAccount.ssn_last4,
                        business_name: scope.customer.balancedAPI.customerAccount.business_name,
                        address: scope.customer.balancedAPI.customerAccount.address,
                        phone: scope.customer.balancedAPI.customerAccount.phone,
                        dob: scope.customer.balancedAPI.customerAccount.dob,
                        ein: scope.customer.balancedAPI.customerAccount.ein,
                        facebook: scope.customer.balancedAPI.customerAccount.facebook,
                        twitter: scope.customer.balancedAPI.customerAccount.twitter
                    };
                    wembliRpc.fetch("customer.updateAccountHolderInfo", accountInfo, function(err) {
                        err && alert("something bad happened contact help@wembli.com"), $location.hash("#payment-information"), 
                        $("#edit-customer-account").modal("hide");
                    }, function(data) {
                        return data;
                    }, function(data) {
                        return JSON.parse(data);
                    });
                };
            };
        }
    };
} ]).directive("addBankAccount", [ "customer", "wembliRpc", "$rootScope", "$location", function(customer, wembliRpc, $rootScope, $location) {
    return {
        restrict: "C",
        replace: !1,
        cache: !1,
        compile: function() {
            return function(scope) {
                scope.addBankAccount = function() {
                    var accountInfo = {
                        name: scope.addBankAccount.accountName,
                        accountNumber: scope.addBankAccount.accountNumber,
                        routingNumber: scope.addBankAccount.routingNumber,
                        type: scope.addBankAccount.accountType
                    };
                    wembliRpc.fetch("customer.addBankAccount", accountInfo, function(err) {
                        err && alert("something bad happened contact help@wembli.com"), $location.hash("#payment-information"), 
                        $("#add-bank-account").modal("hide");
                    }, function(data) {
                        return data;
                    }, function(data) {
                        return JSON.parse(data);
                    });
                };
            };
        }
    };
} ]).directive("deleteBankAccountButton", [ "$rootScope", function($rootScope) {
    return {
        restrict: "C",
        replace: !1,
        cache: !1,
        compile: function() {
            return function(scope, element, attr) {
                attr.$observe("uri", function(uri) {
                    element.click(function() {
                        $rootScope.$broadcast("dashboard-setBankAccountUri", {
                            uri: uri
                        });
                    });
                });
            };
        }
    };
} ]).directive("activityFeed", [ function() {
    return {
        restrict: "E",
        replace: !0,
        cache: !1,
        templateUrl: "/partials/activity-feed",
        compile: function() {}
    };
} ]).directive("deleteBankAccount", [ "customer", "wembliRpc", "$rootScope", "$location", function() {
    return {
        restrict: "C",
        replace: !1,
        cache: !1,
        compile: function() {
            return function(scope) {
                scope.$on("dashboard-setBankAccountUri", function(e, args) {
                    scope.bankAccountUri = args.uri;
                });
            };
        }
    };
} ]);